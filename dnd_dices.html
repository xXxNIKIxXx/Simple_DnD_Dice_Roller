<!DOCTYPE html>
<html lang="en">
    <head>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <title>DND Dice Roller</title>
        <style>
            body {
                background-image: url('https://imgs.search.brave.com/Sr2RkSZ1LSzOm7gvGPmw6Bl30xfhg2OQK2CDQ-JoxQ4/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly90NC5m/dGNkbi5uZXQvanBn/LzA2LzgxLzY3LzAx/LzM2MF9GXzY4MTY3/MDE3MV82YmFPb0R6/Nk5jZFJKQlJmdE9B/U0JzSHdUQkRKQWV0/Uy5qcGc');
                margin: 10px;
                font-family: Arial, sans-serif;
            }
            .dice_section {
                max-width: 600px;
                margin: 0 auto;
                backdrop-filter: blur(20px);
            }
            h2 {
                font-weight: bold;
            }
            .btn-sm {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
            }
            .rounded {
                border-radius: 20px !important;
            }
            @keyframes rollAnimation {
                0% {
                    transform: scale(1) rotate(0deg);
                    opacity: 0.5;
                }
                50% {
                    transform: scale(1.3) rotate(360deg);
                    opacity: 0.8;
                }
                100% {
                    transform: scale(1) rotate(720deg);
                    opacity: 1;
                }
            }
            .rolling {
                animation: rollAnimation 0.6s ease-in-out;
            }
            .nat-1 {
                color: red;
                font-weight: bold;
            }
            .nat-max {
                color: green;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="col">
            <button class="btn btn-success my-3" onclick="addSection()">Add New Section</button>
            <div id="sections-container" class="row" style="--bs-gutter-x:0px;"></div>
        </div>

        <script>
            let sectionCounter = 1;

            function clean_up_sections() {
                document.getElementById("sections-container").childNodes.forEach((section) => {
                    if (section.childNodes.length == 0) {
                        section.remove();
                    }
                });
            }

            function addSection(title="") {
                const container = document.getElementById('sections-container');
                
                const sectionId = `section-${sectionCounter}`;
                const newSection = document.createElement('div');
                newSection.classList.add('col-md-6', 'mb-4');

                const sectionContent = document.createElement('div');
                sectionContent.classList.add('dice_section', 'p-4', 'rounded');
                sectionContent.setAttribute('id', sectionId);

                sectionContent.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <h2 id="title-${sectionCounter}" class="text-info">Dice Roller ${sectionCounter}</h2>
                    </div>
                    <div class="input-group mb-3">
                        <button class="btn btn-danger btn-sm" onclick="removeSection('${sectionId}')">Remove Section</button>
                        <input type="text" id="title-input-${sectionCounter}" class="form-control" placeholder="Enter new title" value="${title}" oninput="save()">
                        <button class="btn btn-success" onclick="updateTitle(${sectionCounter})">Update Title</button>
                    </div>
                    <div id="dice-container-${sectionCounter}" class="mb-3 dice-container">
                    </div>
                    <div class="btn-group" role="group" aria-label="Basic example">
                        <button class="btn btn-success mb-3" onclick="addDice(${sectionCounter})">Add Dice</button>
                        <button class="btn btn-info mb-3" onclick="rollAllDice(${sectionCounter})">Roll All Dice</button>
                    </div>
                `;
                newSection.appendChild(sectionContent);
                container.appendChild(newSection);
                sectionCounter++;
                clean_up_sections();
                save();
            }

            function updateTitle(sectionId) {
                const titleInput = document.getElementById(`title-input-${sectionId}`).value;
                const titleElement = document.getElementById(`title-${sectionId}`);
                if (titleInput.trim()) {
                    titleElement.textContent = titleInput;
                } else {
                    alert("Please enter a valid title.");
                }
                save();
            }

            function addDice(sectionId, diceName = '', diceType = 'D2', diceMod = '') {
                const diceContainer = document.getElementById(`dice-container-${sectionId}`);
                const diceCount = diceContainer.childElementCount + 1;
                diceContainer.innerHTML += generateDiceInputHTML(sectionId, diceCount, diceName=diceName, diceType=diceType, diceMod=diceMod);
                save();
            }

            function removeDice(sectionId, diceId) {
                const diceGroup = document.getElementById(`dice-group-${sectionId}-${diceId}`);
                diceGroup.remove();
                save();
            }

            function removeSection(sectionId) {
                const section = document.getElementById(sectionId);
                section.remove();
                clean_up_sections();
                save();
            }

            function rollDice(diceType) {
                const maxRoll = parseInt(diceType.substring(1));
                return Math.floor(Math.random() * maxRoll) + 1;
            }

            function rollSingleDice(sectionId, diceId) {
                const diceGroup = document.getElementById(`dice-group-${sectionId}-${diceId}`);
                let mod = diceGroup.querySelector('input[type="number"]').value;
                const diceType = diceGroup.querySelector('select').value;
                mod = isNaN(parseInt(mod)) ? 0 : parseInt(mod);
                const resultInput = diceGroup.querySelector('.roll-result');
                
                // Add rolling animation
                resultInput.classList.add('rolling');
                resultInput.value = ""; // Clear field temporarily

                setTimeout(() => {
                    const rollResult = rollDice(diceType);
                    const maxRoll = parseInt(diceType.substring(1));

                    // Update result display
                    resultInput.value = rollResult + mod;

                    // Reset styles
                    resultInput.classList.remove('nat-1', 'nat-max');
                    
                    // Apply styles for nat-1 or nat-max
                    if (rollResult === 1) {
                        resultInput.classList.add('nat-1');
                    } else if (rollResult === maxRoll) {
                        resultInput.classList.add('nat-max');
                    }

                    resultInput.classList.remove('rolling');
                }, 600);
            }

            function rollAllDice(sectionId) {
                const diceContainer = document.getElementById(`dice-container-${sectionId}`);
                const diceGroups = diceContainer.querySelectorAll('.input-group');

                diceGroups.forEach(diceGroup => {
                    let mod = diceGroup.querySelector('input[type="number"]').value;
                    const diceType = diceGroup.querySelector('select').value;
                    mod = isNaN(parseInt(mod)) ? 0 : parseInt(mod);
                    const resultInput = diceGroup.querySelector('.roll-result');
                    
                    // Add rolling animation
                    resultInput.classList.add('rolling');
                    resultInput.value = ""; // Clear field temporarily

                    setTimeout(() => {
                        const rollResult = rollDice(diceType);
                        const maxRoll = parseInt(diceType.substring(1));

                        // Update result display
                        resultInput.value = rollResult + mod;

                        // Reset styles
                        resultInput.classList.remove('nat-1', 'nat-max');
                        
                        // Apply styles for nat-1 or nat-max
                        if (rollResult === 1) {
                            resultInput.classList.add('nat-1');
                        } else if (rollResult === maxRoll) {
                            resultInput.classList.add('nat-max');
                        }

                        resultInput.classList.remove('rolling');
                    }, 600);
                });
            }

            function generateDiceInputHTML(sectionId, diceId, diceName, diceType, diceMod) {
                return `
                    <div class="input-group mb-2" id="dice-group-${sectionId}-${diceId}">
                        <button class="btn btn-danger btn-sm" onclick="removeDice(${sectionId}, ${diceId})">x</button>
                        <input type="text" class="form-control" placeholder="Enter text" value="${diceName}" oninput="save()">
                        <select class="form-select" oninput="save()">
                            <option value="D2" ${diceType === 'D2' ? 'selected' : ''}>D2</option>
                            <option value="D3" ${diceType === 'D3' ? 'selected' : ''}>D3</option>
                            <option value="D4" ${diceType === 'D4' ? 'selected' : ''}>D4</option>
                            <option value="D6" ${diceType === 'D6' ? 'selected' : ''}>D6</option>
                            <option value="D8" ${diceType === 'D8' ? 'selected' : ''}>D8</option>
                            <option value="D10" ${diceType === 'D10' ? 'selected' : ''}>D10</option>
                            <option value="D12" ${diceType === 'D12' ? 'selected' : ''}>D12</option>
                            <option value="D20" ${diceType === 'D20' ? 'selected' : ''}>D20</option>
                            <option value="D100" ${diceType === 'D100' ? 'selected' : ''}>D100</option>
                        </select>
                        <input type="number" class="form-control" placeholder="Modifier" oninput="save()" value="${diceMod}">
                        <input type="text" class="form-control roll-result" placeholder="Result" disabled readonly>
                        <button class="btn btn-info" onclick="rollSingleDice(${sectionId}, ${diceId})">Roll</button>
                    </div>
                `;
            }

            function save() {
                const sections_data = [];
                const sections = document.querySelectorAll('.dice_section');
                sections.forEach((section) => {
                    const section_data = {
                        title: section.querySelector('h2').textContent,
                        dices: []
                    };
                    const dices = Array.from(section.querySelector(".dice-container").children);
                    dices.forEach((dice) => {
                        const dice_data = {
                            name: dice.querySelector('input[type="text"]').value,
                            type: dice.querySelector('select').value,
                            mod: dice.querySelector('input[type="number"]').value
                        };
                        section_data.dices.push(dice_data);
                    });
                    sections_data.push(section_data);
                });
                const json_data = JSON.stringify({ sections: sections_data });
                localStorage.setItem('dice_roll_app_data', json_data);
            }
            function load() {
                const savedData = localStorage.getItem('dice_roll_app_data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    data.sections.forEach((section, index) => {
                        addSection();
                        const sectionId = index + 1;
                        console.log(document.getElementById(`title-${sectionId}`))
                        document.getElementById(`title-${sectionId}`).textContent = section.title;
                        section.dices.forEach((dice, diceIndex) => {
                            addDice(sectionId, dice.name, dice.type, dice.mod);
                            const diceGroup = document.getElementById(`dice-group-${sectionId}-${diceIndex + 1}`);
                            diceGroup.querySelector('input[type="text"]').value = dice.name;
                            diceGroup.querySelector('select').value = dice.type;
                            diceGroup.querySelector('input[type="number"]').value = dice.mod;
                        });
                    });
                }
                save()
            }

            window.onload = load;
        </script>
    </body>
</html>